document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("table-of-contents"),t=document.querySelector("main"),s=document.documentElement,n=await fetch("toc.json"),o=await n.json();let r=!1;o.forEach((s,n)=>{e.insertAdjacentHTML("beforeend",`<li><b>${n+1}.</b> <a href="#${s.id}">${s.title}</a></li>`),document.getElementById(s.id)||t.insertAdjacentHTML("beforeend",`<div class="lazy-section" id="${s.id}" data-src="${s.file}"></div>`)});const c=Array.from(document.querySelectorAll(".lazy-section"));async function a(e){if(e&&!e.classList.contains("loaded")&&!e.classList.contains("loading")){e.classList.add("loading");try{const t=await fetch(e.dataset.src).then(e=>e.text());e.innerHTML=t,e.classList.add("loaded"),e.style.minHeight="0"}catch(e){console.error(e)}e.classList.remove("loading")}}const i=new IntersectionObserver(e=>{r||e.forEach(e=>{if(e.isIntersecting){const t=e.target;a(t);const n=parseInt(t.id.replace("section-",""));if(!isNaN(n)){const e=10+(n-1)/(o.length-1)*90;s.style.setProperty("--progress",e+"%")}}})},{rootMargin:"50px"});c.forEach(e=>i.observe(e)),e.addEventListener("click",async e=>{const t=e.target.closest("a");if(!t)return;e.preventDefault(),r=!0;const n=t.getAttribute("href").slice(1),c=document.getElementById(n),i=c.previousElementSibling,l=parseInt(n.replace("section-",""));if(!isNaN(l)){const e=10+(l-1)/(o.length-1)*90;s.style.setProperty("--progress",e+"%")}const d=[a(c)];i&&i.classList.contains("lazy-section")&&d.push(a(i)),await Promise.all(d),await Promise.all(Array.from(c.querySelectorAll("img")).map(e=>e.complete?Promise.resolve():new Promise(t=>{e.onload=t,e.onerror=t}))),requestAnimationFrame(()=>{c.scrollIntoView({block:"start"}),history.pushState(null,null,"#"+n)}),setTimeout(()=>{r=!1},200)});const l=document.querySelector("#logo-navbar");l&&l.addEventListener("click",()=>s.style.setProperty("--progress","0%"));const d=document.querySelector("#button-toc");d&&d.addEventListener("click",()=>s.style.setProperty("--progress","5%"))});
function ensureOverlay(){let e=document.querySelector(".magnify-overlay");if(e)return e;e=document.createElement("div"),e.className="magnify-overlay",e.setAttribute("role","dialog"),e.setAttribute("aria-hidden","true");const t=document.createElement("img");return e.appendChild(t),e.addEventListener("click",()=>{e.classList.remove("active"),e.setAttribute("aria-hidden","true"),setTimeout(()=>{e.querySelector("img").src=""},300)}),document.body.appendChild(e),e}document.addEventListener("click",e=>{const t=e.target.closest(".magnifiable");if(!t)return;const r=ensureOverlay();r.querySelector("img").src=t.src,r.setAttribute("aria-hidden","false"),r.classList.add("active")});
document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".navbar");function t(){window.scrollY>=0?e.classList.add("scrolled"):e.classList.remove("scrolled")}window.addEventListener("scroll",t),t(),window.addEventListener("popstate",e=>{const t=document.getElementById("donateOverlay");"flex"!==t.style.display||e.state&&e.state.panelOpen||(t.style.display="none")})});
function toggleDonatePanel(e){e.preventDefault();const t=document.getElementById("donateOverlay");"flex"===t.style.display?(t.style.display="none",history.state&&history.state.panelOpen&&history.replaceState({},document.title,window.location.pathname+window.location.search)):(t.style.display="flex",history.pushState({panelOpen:!0},"Donate Panel Open","#donate-panel-open"))}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("placeholder-panel-donate");e&&fetch("html/panel-donate.html").then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.text()}).then(t=>{const n=document.createElement("div");n.innerHTML=t,e.replaceWith(...n.childNodes)}).catch(e=>{console.error("Failed to load overlay:",e)})}),document.addEventListener("click",e=>{e.target.closest("#donateOverlay");"donateOverlay"===e.target.id&&toggleDonatePanel(e)}),document.addEventListener("keydown",e=>{if("Escape"===e.key){const t=document.getElementById("donateOverlay");t&&"flex"===t.style.display&&toggleDonatePanel(e)}}),window.addEventListener("popstate",e=>{const t=document.getElementById("donateOverlay");t&&"flex"===t.style.display&&(t.style.display="none")});
const trimTextStream=e=>{e.classList.contains("textstream")&&(e.innerHTML=e.innerHTML.replace(/^\s+|\s+$/g,""))};document.querySelectorAll(".textstream").forEach(trimTextStream);const observer=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{1===e.nodeType&&(e.classList.contains("textstream")&&trimTextStream(e),e.querySelectorAll(".textstream").forEach(trimTextStream))})})});observer.observe(document.body,{childList:!0,subtree:!0});