document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("table-of-contents"),t=document.querySelector("main"),n=document.documentElement,o=await fetch("toc.json"),s=await o.json();let i=!1;const a=e=>{const t=parseInt(e.replace("section-",""));if(isNaN(t))return;const o=10+(t-1)/(s.length-1)*90;n.style.setProperty("--progress",`${o}%`)};s.forEach((n,o)=>{e.insertAdjacentHTML("beforeend",`<li><b>${o+1}.</b> <a href="#${n.id}">${n.title}</a></li>`),document.getElementById(n.id)||t.insertAdjacentHTML("beforeend",`<div class="lazy-section" id="${n.id}" data-src="${n.file}"></div>`)});const r=Array.from(document.querySelectorAll(".lazy-section"));async function c(e){if(e&&!e.classList.contains("loaded")&&!e.classList.contains("loading")){e.classList.add("loading");try{const t=await fetch(e.dataset.src).then(e=>e.text());if(e.innerHTML=t,e.classList.add("loaded"),e.style.minHeight="0",e.offsetHeight<window.innerHeight){const t=e.nextElementSibling;t?.classList.contains("lazy-section")&&c(t)}}catch(t){console.error(`Failed to load ${e.id}:`,t)}e.classList.remove("loading")}}const l=new IntersectionObserver(e=>{i||e.forEach(e=>{e.isIntersecting&&(c(e.target),a(e.target.id))})},{root:null,rootMargin:"300px",threshold:0});r.forEach(e=>l.observe(e)),e.addEventListener("click",async e=>{const t=e.target.closest("a");if(!t)return;e.preventDefault(),document.body.classList.add("is-loading"),i=!0;const n=t.getAttribute("href").slice(1),o=document.getElementById(n);if(!o)return;const s=o.previousElementSibling,r=o.nextElementSibling,l=[c(o)];s?.classList.contains("lazy-section")&&l.push(c(s)),r?.classList.contains("lazy-section")&&l.push(c(r)),await Promise.all(l);const d=Array.from(o.querySelectorAll("img"));await Promise.all(d.map(e=>e.complete||!e.src?Promise.resolve():new Promise(t=>{e.onload=e.onerror=t,setTimeout(t,500)}))),requestAnimationFrame(()=>{o.scrollIntoView({block:"start"}),window.location.hash!==`#${n}`&&(window.location.hash=n),a(n),document.body.classList.remove("is-loading"),setTimeout(()=>{i=!1},250)})}),document.querySelector("#logo-navbar")?.addEventListener("click",()=>n.style.setProperty("--progress","0%")),document.querySelector("#button-toc")?.addEventListener("click",()=>n.style.setProperty("--progress","5%"))});
function ensureOverlay(){let e=document.querySelector(".magnify-overlay");if(e)return e;e=document.createElement("div"),e.className="magnify-overlay",e.setAttribute("role","dialog"),e.setAttribute("aria-hidden","true");const t=document.createElement("img");return e.appendChild(t),e.addEventListener("click",()=>{e.classList.remove("active"),e.setAttribute("aria-hidden","true"),setTimeout(()=>{e.querySelector("img").src=""},300)}),document.body.appendChild(e),e}document.addEventListener("click",e=>{const t=e.target.closest(".magnifiable");if(!t)return;const r=ensureOverlay();r.querySelector("img").src=t.src,r.setAttribute("aria-hidden","false"),r.classList.add("active")});
document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".navbar");function t(){window.scrollY>=0?e.classList.add("scrolled"):e.classList.remove("scrolled")}window.addEventListener("scroll",t),t(),window.addEventListener("popstate",e=>{const t=document.getElementById("donateOverlay");"flex"!==t.style.display||e.state&&e.state.panelOpen||(t.style.display="none")})});
function toggleDonatePanel(e){e.preventDefault();const t=document.getElementById("donateOverlay");"flex"===t.style.display?(t.style.display="none",history.state&&history.state.panelOpen&&history.replaceState({},document.title,window.location.pathname+window.location.search)):(t.style.display="flex",history.pushState({panelOpen:!0},"Donate Panel Open","#donate-panel-open"))}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("placeholder-panel-donate");e&&fetch("html/panel-donate.html").then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.text()}).then(t=>{const n=document.createElement("div");n.innerHTML=t,e.replaceWith(...n.childNodes)}).catch(e=>{console.error("Failed to load overlay:",e)})}),document.addEventListener("click",e=>{e.target.closest("#donateOverlay");"donateOverlay"===e.target.id&&toggleDonatePanel(e)}),document.addEventListener("keydown",e=>{if("Escape"===e.key){const t=document.getElementById("donateOverlay");t&&"flex"===t.style.display&&toggleDonatePanel(e)}}),window.addEventListener("popstate",e=>{const t=document.getElementById("donateOverlay");t&&"flex"===t.style.display&&(t.style.display="none")});
const trimTextStream=e=>{e.classList.contains("textstream")&&(e.innerHTML=e.innerHTML.replace(/^\s+|\s+$/g,""))};document.querySelectorAll(".textstream").forEach(trimTextStream);const observer=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{1===e.nodeType&&(e.classList.contains("textstream")&&trimTextStream(e),e.querySelectorAll(".textstream").forEach(trimTextStream))})})});observer.observe(document.body,{childList:!0,subtree:!0});