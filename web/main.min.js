(()=>{const t=document.querySelectorAll(".lazy-section"),e=Array.from(t).filter(t=>t.closest("main")),r=e.length,n=document.getElementById("table-of-contents"),o=document.documentElement;e.forEach(async(t,e)=>{const r=t.dataset.src,o=e+1;t.id||(t.id=`section-${o}`);try{const e=await fetch(r),s=await e.text(),c=new DOMParser,a=c.parseFromString(s,"text/html").querySelector("h2"),i=a?a.textContent.trim():`Section ${o}`,l=document.createElement("li");l.innerHTML=`<b>${o}.</b> <a href="#${t.id}">${i}</a>`,n.appendChild(l)}catch(t){console.error(`ToC error for ${r}`)}});const s=new IntersectionObserver(t=>{t.forEach(t=>{const n=t.target,s=n.getAttribute("data-src");if(t.isIntersecting){const t=e.indexOf(n);if(-1!==t){const e=(t+1)/r*100;o.style.setProperty("--progress",e+"%")}s&&!n.classList.contains("loaded")&&fetch(s).then(t=>{if(!t.ok)throw new Error(`Status: ${t.status}`);return t.text()}).then(t=>{n.innerHTML=t,n.classList.add("loaded"),n.style.minHeight="0"}).catch(t=>{console.error(`Error loading ${s}:`,t),n.innerHTML='<p style="color:red;">Failed to load content.</p>'})}})},{rootMargin:"200px",threshold:.01});n.addEventListener("click",async t=>{const e=t.target.closest("a");if(!e)return;t.preventDefault();const r=e.getAttribute("href").slice(1),n=document.getElementById(r);if(n){if(!n.classList.contains("loaded")){const t=n.getAttribute("data-src");try{const e=await fetch(t);n.innerHTML=await e.text(),n.classList.add("loaded"),n.style.minHeight="0"}catch(t){console.error(t)}}n.scrollIntoView(),history.pushState(null,null,"#"+r)}}),t.forEach(t=>s.observe(t))})();
function ensureOverlay(){let e=document.querySelector(".magnify-overlay");if(e)return e;e=document.createElement("div"),e.className="magnify-overlay",e.setAttribute("role","dialog"),e.setAttribute("aria-hidden","true");const t=document.createElement("img");return e.appendChild(t),e.addEventListener("click",()=>{e.classList.remove("active"),e.setAttribute("aria-hidden","true"),setTimeout(()=>{e.querySelector("img").src=""},300)}),document.body.appendChild(e),e}document.addEventListener("click",e=>{const t=e.target.closest(".magnifiable");if(!t)return;const r=ensureOverlay();r.querySelector("img").src=t.src,r.setAttribute("aria-hidden","false"),r.classList.add("active")});
document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".navbar");function t(){window.scrollY>=0?e.classList.add("scrolled"):e.classList.remove("scrolled")}window.addEventListener("scroll",t),t(),window.addEventListener("popstate",e=>{const t=document.getElementById("donateOverlay");"flex"!==t.style.display||e.state&&e.state.panelOpen||(t.style.display="none")})});
function toggleDonatePanel(e){e.preventDefault();const t=document.getElementById("donateOverlay");"flex"===t.style.display?(t.style.display="none",history.state&&history.state.panelOpen&&history.replaceState({},document.title,window.location.pathname+window.location.search)):(t.style.display="flex",history.pushState({panelOpen:!0},"Donate Panel Open","#donate-panel-open"))}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("placeholder-panel-donate");e&&fetch("html/panel-donate.html").then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.text()}).then(t=>{const n=document.createElement("div");n.innerHTML=t,e.replaceWith(...n.childNodes)}).catch(e=>{console.error("Failed to load overlay:",e)})}),document.addEventListener("click",e=>{e.target.closest("#donateOverlay");"donateOverlay"===e.target.id&&toggleDonatePanel(e)}),document.addEventListener("keydown",e=>{if("Escape"===e.key){const t=document.getElementById("donateOverlay");t&&"flex"===t.style.display&&toggleDonatePanel(e)}}),window.addEventListener("popstate",e=>{const t=document.getElementById("donateOverlay");t&&"flex"===t.style.display&&(t.style.display="none")});
const trimTextStream=e=>{e.classList.contains("textstream")&&(e.innerHTML=e.innerHTML.replace(/^\s+|\s+$/g,""))};document.querySelectorAll(".textstream").forEach(trimTextStream);const observer=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{1===e.nodeType&&(e.classList.contains("textstream")&&trimTextStream(e),e.querySelectorAll(".textstream").forEach(trimTextStream))})})});observer.observe(document.body,{childList:!0,subtree:!0});