function loadLazySection(t){const e=t.dataset.src;e&&fetch(e).then(t=>{if(!t.ok)throw new Error(`HTTP error: ${t.status}`);return t.text()}).then(e=>{const r=document.createElement("div");r.innerHTML=e,t.replaceWith(...r.childNodes)}).catch(t=>console.error(`Failed to load ${e}:`,t))}(()=>{const t=document.querySelectorAll(".lazy-section"),e=Array.from(t).filter(t=>t.closest("main")),r=e.length,o=document.getElementById("table-of-contents"),n=document.documentElement;e.forEach(async(t,e)=>{const r=t.dataset.src,n=e+1;t.id||(t.id=`section-${n}`);try{const e=await fetch(r),c=await e.text(),s=new DOMParser,a=s.parseFromString(c,"text/html").querySelector("h2"),i=a?a.textContent.trim():`Section ${n}`,l=document.createElement("li");l.innerHTML=`<b>${n}.</b> <a href="#${t.id}">${i}</a>`,o.appendChild(l)}catch(t){console.error(`ToC error for ${r}`)}});const c=new IntersectionObserver(t=>{t.forEach(t=>{const o=t.target,c=o.getAttribute("data-src");if(t.isIntersecting){const t=e.indexOf(o);if(-1!==t){const e=(t+1)/r*100;n.style.setProperty("--progress",e+"%")}c&&!o.classList.contains("loaded")&&fetch(c).then(t=>{if(!t.ok)throw new Error(`Status: ${t.status}`);return t.text()}).then(t=>{o.innerHTML=t,o.classList.add("loaded"),o.style.minHeight="0"}).catch(t=>{console.error(`Error loading ${c}:`,t),o.innerHTML='<p style="color:red;">Failed to load content.</p>'})}})},{rootMargin:"200px",threshold:.01});t.forEach(t=>c.observe(t))})();
function ensureOverlay(){let e=document.querySelector(".magnify-overlay");if(e)return e;e=document.createElement("div"),e.className="magnify-overlay",e.setAttribute("role","dialog"),e.setAttribute("aria-hidden","true");const t=document.createElement("img");return e.appendChild(t),e.addEventListener("click",()=>{e.classList.remove("active"),e.setAttribute("aria-hidden","true"),setTimeout(()=>{e.querySelector("img").src=""},300)}),document.body.appendChild(e),e}document.addEventListener("click",e=>{const t=e.target.closest(".magnifiable");if(!t)return;const r=ensureOverlay();r.querySelector("img").src=t.src,r.setAttribute("aria-hidden","false"),r.classList.add("active")});
document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".navbar");function t(){window.scrollY>=0?e.classList.add("scrolled"):e.classList.remove("scrolled")}window.addEventListener("scroll",t),t(),window.addEventListener("popstate",e=>{const t=document.getElementById("donateOverlay");"flex"!==t.style.display||e.state&&e.state.panelOpen||(t.style.display="none")})});
function toggleDonatePanel(e){e.preventDefault();const t=document.getElementById("donateOverlay");"flex"===t.style.display?(t.style.display="none",history.state&&history.state.panelOpen&&history.replaceState({},document.title,window.location.pathname+window.location.search)):(t.style.display="flex",history.pushState({panelOpen:!0},"Donate Panel Open","#donate-panel-open"))}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("placeholder-panel-donate");e&&fetch("html/panel-donate.html").then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.text()}).then(t=>{const n=document.createElement("div");n.innerHTML=t,e.replaceWith(...n.childNodes)}).catch(e=>{console.error("Failed to load overlay:",e)})}),document.addEventListener("click",e=>{e.target.closest("#donateOverlay");"donateOverlay"===e.target.id&&toggleDonatePanel(e)}),document.addEventListener("keydown",e=>{if("Escape"===e.key){const t=document.getElementById("donateOverlay");t&&"flex"===t.style.display&&toggleDonatePanel(e)}}),window.addEventListener("popstate",e=>{const t=document.getElementById("donateOverlay");t&&"flex"===t.style.display&&(t.style.display="none")});
const trimTextStream=e=>{e.classList.contains("textstream")&&(e.innerHTML=e.innerHTML.replace(/^\s+|\s+$/g,""))};document.querySelectorAll(".textstream").forEach(trimTextStream);const observer=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{1===e.nodeType&&(e.classList.contains("textstream")&&trimTextStream(e),e.querySelectorAll(".textstream").forEach(trimTextStream))})})});observer.observe(document.body,{childList:!0,subtree:!0});